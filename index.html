<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Futures Analysis Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        function FuturesAnalysisDashboard() {
            const [question, setQuestion] = useState('');
            const [loading, setLoading] = useState(false);
            const [analysis, setAnalysis] = useState(null);
            const [error, setError] = useState('');
            const [showHistory, setShowHistory] = useState(false);
            const [history, setHistory] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [downloadingPDF, setDownloadingPDF] = useState(false);

            useEffect(() => {
                loadHistory();
            }, []);

            const loadHistory = async () => {
                try {
                    const keys = await window.storage.list('analysis:');
                    if (keys && keys.keys) {
                        const analyses = [];
                        for (const key of keys.keys) {
                            try {
                                const result = await window.storage.get(key);
                                if (result) analyses.push(JSON.parse(result.value));
                            } catch (e) {
                                console.log('Could not load:', key);
                            }
                        }
                        analyses.sort((a, b) => b.timestamp - a.timestamp);
                        setHistory(analyses);
                    }
                } catch (e) {
                    console.log('No history available');
                }
            };

            const analyzeQuestion = async () => {
                if (!question.trim()) {
                    setError('Please enter a question');
                    return;
                }

                setLoading(true);
                setError('');
                setAnalysis(null);

                try {
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ question })
                    });

                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    const textContent = data.content
                        .filter(item => item.type === 'text')
                        .map(item => item.text)
                        .join('');

                    const jsonMatch = textContent.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) {
                        throw new Error('Could not parse response');
                    }

                    const parsedAnalysis = JSON.parse(jsonMatch[0]);
                    setAnalysis(parsedAnalysis);
                    
                    await saveAnalysis(parsedAnalysis);
                    await loadHistory();
                } catch (err) {
                    setError(err.message || 'An error occurred during analysis');
                } finally {
                    setLoading(false);
                }
            };

            const saveAnalysis = async (analysisData) => {
                try {
                    const id = Date.now().toString();
                    const data = {
                        id,
                        question,
                        analysis: analysisData,
                        timestamp: Date.now()
                    };
                    await window.storage.set(`analysis:${id}`, JSON.stringify(data));
                } catch (e) {
                    console.error('Could not save analysis:', e);
                }
            };

            const loadHistoricalAnalysis = (item) => {
                setQuestion(item.question);
                setAnalysis(item.analysis);
                setShowHistory(false);
                setSearchTerm('');
            };

            const filteredHistory = history.filter(item => 
                item.question.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const downloadPDF = async () => {
                if (!analysis) return;
                
                setDownloadingPDF(true);
                
                try {
                    const element = document.getElementById('pdf-content');
                    const opt = {
                        margin: 10,
                        filename: `futures-analysis-${Date.now()}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    };
                    
                    await html2pdf().set(opt).from(element).save();
                } catch (error) {
                    console.error('PDF generation error:', error);
                    setError('Could not generate PDF. Please try again.');
                } finally {
                    setDownloadingPDF(false);
                }
            };

            const pestleCategories = [
                { key: 'political', label: 'Political', color: 'bg-blue-100 text-blue-800' },
                { key: 'economic', label: 'Economic', color: 'bg-green-100 text-green-800' },
                { key: 'social', label: 'Social', color: 'bg-purple-100 text-purple-800' },
                { key: 'technological', label: 'Technological', color: 'bg-cyan-100 text-cyan-800' },
                { key: 'legal', label: 'Legal', color: 'bg-amber-100 text-amber-800' },
                { key: 'environmental', label: 'Environmental', color: 'bg-emerald-100 text-emerald-800' },
                { key: 'military', label: 'Military', color: 'bg-red-100 text-red-800' }
            ];

            const scenarioColors = {
                'Baseline': 'border-blue-500 bg-blue-50',
                'Plausible': 'border-amber-500 bg-amber-50',
                'Wildcard': 'border-purple-500 bg-purple-50'
            };

            const RiskMatrix = () => {
                const risks = analysis.scenarios.map(scenario => ({
                    name: scenario.type,
                    likelihood: scenario.probability,
                    impact: scenario.type === 'Baseline' ? 60 : scenario.type === 'Plausible' ? 75 : 90
                }));

                return (
                    <div className="bg-white rounded-lg shadow-lg p-6">
                        <h2 className="text-2xl font-bold text-slate-800 mb-4">Risk Assessment Matrix</h2>
                        <p className="text-slate-600 mb-6">Visual representation of scenario likelihood vs potential impact</p>
                        
                        <div className="relative w-full h-96 border-2 border-slate-300 rounded-lg bg-gradient-to-tr from-green-50 via-yellow-50 to-red-50">
                            {/* Y-axis label */}
                            <div className="absolute -left-16 top-1/2 -translate-y-1/2 -rotate-90 text-sm font-semibold text-slate-700">
                                Impact ‚Üí
                            </div>
                            
                            {/* X-axis label */}
                            <div className="absolute bottom-0 left-1/2 -translate-x-1/2 translate-y-8 text-sm font-semibold text-slate-700">
                                Likelihood ‚Üí
                            </div>

                            {/* Grid lines */}
                            <div className="absolute inset-0 grid grid-cols-3 grid-rows-3">
                                {[...Array(9)].map((_, i) => (
                                    <div key={i} className="border border-slate-200"></div>
                                ))}
                            </div>

                            {/* Zone labels */}
                            <div className="absolute top-2 left-2 text-xs font-semibold text-green-700 bg-white/70 px-2 py-1 rounded">LOW</div>
                            <div className="absolute top-2 right-2 text-xs font-semibold text-orange-700 bg-white/70 px-2 py-1 rounded">MEDIUM</div>
                            <div className="absolute bottom-2 right-2 text-xs font-semibold text-red-700 bg-white/70 px-2 py-1 rounded">HIGH</div>

                            {/* Plot scenarios */}
                            {risks.map((risk, idx) => {
                                const x = (risk.likelihood / 100) * 100;
                                const y = 100 - (risk.impact / 100) * 100;
                                const colors = {
                                    'Baseline': 'bg-blue-500',
                                    'Plausible': 'bg-amber-500',
                                    'Wildcard': 'bg-purple-500'
                                };
                                
                                return (
                                    <div
                                        key={idx}
                                        className={`absolute w-16 h-16 ${colors[risk.name]} rounded-full flex items-center justify-center text-white font-bold text-xs shadow-lg transform -translate-x-1/2 -translate-y-1/2 cursor-pointer hover:scale-110 transition-transform`}
                                        style={{ left: `${x}%`, top: `${y}%` }}
                                        title={`${risk.name}: ${risk.likelihood}% likelihood, ${risk.impact}% impact`}
                                    >
                                        {risk.name}
                                    </div>
                                );
                            })}
                        </div>

                        <div className="mt-6 grid grid-cols-3 gap-4">
                            {risks.map((risk, idx) => (
                                <div key={idx} className="flex items-center gap-2 text-sm">
                                    <div className={`w-4 h-4 rounded-full ${
                                        risk.name === 'Baseline' ? 'bg-blue-500' :
                                        risk.name === 'Plausible' ? 'bg-amber-500' : 'bg-purple-500'
                                    }`}></div>
                                    <span className="font-medium">{risk.name}:</span>
                                    <span className="text-slate-600">{risk.likelihood}% / {risk.impact}%</span>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-6">
                    <div className="max-w-6xl mx-auto">
                        <header className="text-center mb-8">
                            <h1 className="text-4xl font-bold text-slate-800 mb-2">Futures Analysis Dashboard</h1>
                            <p className="text-slate-600">Strategic foresight powered by PESTLE-M framework</p>
                        </header>

                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            {history.length > 0 && (
                                <div className="flex gap-2 mb-4">
                                    <button
                                        onClick={() => setShowHistory(!showHistory)}
                                        className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors"
                                    >
                                        üìä History ({history.length})
                                    </button>
                                    {analysis && (
                                        <button
                                            onClick={downloadPDF}
                                            disabled={downloadingPDF}
                                            className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:bg-slate-400 rounded-lg transition-colors"
                                        >
                                            {downloadingPDF ? '‚è≥ Generating...' : 'üì• Download PDF'}
                                        </button>
                                    )}
                                </div>
                            )}

                            {showHistory && history.length > 0 && (
                                <div className="mb-4">
                                    <input
                                        type="text"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        placeholder="üîç Search your history..."
                                        className="w-full px-4 py-2 mb-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                    <div className="max-h-64 overflow-y-auto border border-slate-200 rounded-lg">
                                        {filteredHistory.length > 0 ? (
                                            filteredHistory.map((item) => (
                                                <button
                                                    key={item.id}
                                                    onClick={() => loadHistoricalAnalysis(item)}
                                                    className="w-full text-left p-4 hover:bg-slate-50 border-b border-slate-100 last:border-b-0 transition-colors"
                                                >
                                                    <div className="flex items-start justify-between gap-4">
                                                        <div className="flex-1">
                                                            <p className="font-medium text-slate-800 line-clamp-2">{item.question}</p>
                                                            <div className="flex items-center gap-2 mt-1 text-xs text-slate-500">
                                                                üïê {new Date(item.timestamp).toLocaleString()}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </button>
                                            ))
                                        ) : (
                                            <div className="p-4 text-center text-slate-500">
                                                No results found for "{searchTerm}"
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            <div className="mb-4">
                                <label className="block text-sm font-medium text-slate-700 mb-2">
                                    Your Question About the Future
                                </label>
                                <textarea
                                    value={question}
                                    onChange={(e) => setQuestion(e.target.value)}
                                    placeholder="e.g., Will Taiwan be invaded by China?"
                                    rows={3}
                                    className="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                />
                            </div>

                            <button
                                onClick={analyzeQuestion}
                                disabled={loading}
                                className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-slate-400 text-white font-semibold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-colors"
                            >
                                {loading ? (
                                    <>
                                        <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                                        Analyzing...
                                    </>
                                ) : (
                                    <>
                                        üöÄ Analyze Future Scenario
                                    </>
                                )}
                            </button>

                            {error && (
                                <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-2">
                                    <span className="text-red-600">‚ö†Ô∏è</span>
                                    <p className="text-red-800 text-sm">{error}</p>
                                </div>
                            )}
                        </div>

                        {/* Hidden PDF content */}
                        {analysis && (
                            <div id="pdf-content" style={{ position: 'absolute', left: '-9999px', top: 0 }}>
                                <div style={{ padding: '40px', fontFamily: 'Arial, sans-serif', maxWidth: '800px' }}>
                                    <h1 style={{ color: '#1e40af', borderBottom: '3px solid #1e40af', paddingBottom: '10px', marginBottom: '20px' }}>
                                        Futures Analysis Report
                                    </h1>
                                    <div style={{ color: '#64748b', marginBottom: '30px' }}>
                                        Generated: {new Date().toLocaleDateString()}
                                    </div>
                                    
                                    <div style={{ background: '#f1f5f9', padding: '15px', borderLeft: '4px solid #3b82f6', margin: '20px 0' }}>
                                        <strong>Question:</strong> {question}
                                    </div>

                                    <h2 style={{ color: '#334155', marginTop: '30px' }}>PESTLE-M Framework Analysis</h2>
                                    {Object.entries(analysis.pestle_analysis).map(([key, value]) => (
                                        <div key={key} style={{ margin: '20px 0', padding: '15px', background: '#f8fafc', borderRadius: '8px' }}>
                                            <div style={{ fontWeight: 'bold', color: '#0f766e', marginBottom: '8px', textTransform: 'uppercase' }}>
                                                {key}
                                            </div>
                                            <div>{value}</div>
                                        </div>
                                    ))}

                                    <h2 style={{ color: '#334155', marginTop: '30px' }}>Overall Assessment</h2>
                                    <p>{analysis.overall_assessment}</p>

                                    <h2 style={{ color: '#334155', marginTop: '30px' }}>Future Scenarios</h2>
                                    {analysis.scenarios.map((scenario, idx) => (
                                        <div key={idx} style={{ margin: '20px 0', padding: '20px', border: '2px solid #cbd5e1', borderRadius: '8px' }}>
                                            <h3 style={{ color: '#475569' }}>
                                                {scenario.type} Scenario <span style={{ fontSize: '24px', fontWeight: 'bold', color: '#1e40af' }}>{scenario.probability}%</span>
                                            </h3>
                                            <p><strong>Timeframe:</strong> {scenario.timeframe}</p>
                                            <p>{scenario.description}</p>
                                            <p><strong>Key Indicators:</strong></p>
                                            <ul>
                                                {scenario.key_indicators.map((ind, i) => (
                                                    <li key={i}>{ind}</li>
                                                ))}
                                            </ul>
                                        </div>
                                    ))}

                                    {analysis.strategic_questions && (
                                        <>
                                            <h2 style={{ color: '#334155', marginTop: '30px' }}>Strategic Questions for Leadership</h2>
                                            <ol style={{ paddingLeft: '20px' }}>
                                                {analysis.strategic_questions.map((q, idx) => (
                                                    <li key={idx} style={{ margin: '10px 0' }}>{q}</li>
                                                ))}
                                            </ol>
                                        </>
                                    )}

                                    {analysis.data_sources && (
                                        <>
                                            <h2 style={{ color: '#334155', marginTop: '30px' }}>Data Sources & References</h2>
                                            <ul style={{ paddingLeft: '20px' }}>
                                                {analysis.data_sources.map((source, idx) => (
                                                    <li key={idx} style={{ margin: '8px 0' }}>{source}</li>
                                                ))}
                                            </ul>
                                        </>
                                    )}

                                    <div style={{ marginTop: '40px', paddingTop: '20px', borderTop: '1px solid #cbd5e1', fontSize: '12px', color: '#64748b' }}>
                                        This report was generated by the Futures Analysis Dashboard using PESTLE-M strategic foresight methodology.
                                    </div>
                                </div>
                            </div>
                        )}

                        {analysis && (
                            <div className="space-y-6">
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <h2 className="text-2xl font-bold text-slate-800 mb-4">PESTLE-M Analysis</h2>
                                    <div className="grid md:grid-cols-2 gap-4">
                                        {pestleCategories.map(({ key, label, color }) => (
                                            <div key={key} className="border border-slate-200 rounded-lg p-4">
                                                <div className={`inline-block px-3 py-1 rounded-full text-sm font-semibold mb-2 ${color}`}>
                                                    {label}
                                                </div>
                                                <p className="text-slate-700 text-sm">{analysis.pestle_analysis[key]}</p>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <h2 className="text-2xl font-bold text-slate-800 mb-2">Future Scenarios</h2>
                                    <p className="text-slate-600 mb-6">{analysis.overall_assessment}</p>
                                    
                                    <div className="space-y-4">
                                        {analysis.scenarios.map((scenario, idx) => (
                                            <div
                                                key={idx}
                                                className={`border-l-4 rounded-lg p-5 ${scenarioColors[scenario.type]}`}
                                            >
                                                <div className="flex items-start justify-between mb-3">
                                                    <h3 className="text-xl font-bold text-slate-800">{scenario.type} Scenario</h3>
                                                    <div className="text-right">
                                                        <div className="text-2xl font-bold text-slate-800">{scenario.probability}%</div>
                                                        <div className="text-xs text-slate-600">Probability</div>
                                                    </div>
                                                </div>
                                                
                                                <p className="text-slate-700 mb-3">{scenario.description}</p>
                                                
                                                <div className="flex items-center gap-4 text-sm mb-3">
                                                    <div>
                                                        <span className="font-semibold text-slate-700">Timeframe:</span>
                                                        <span className="text-slate-600 ml-1">{scenario.timeframe}</span>
                                                    </div>
                                                </div>

                                                <div>
                                                    <p className="font-semibold text-slate-700 text-sm mb-2">Key Indicators:</p>
                                                    <ul className="list-disc list-inside space-y-1">
                                                        {scenario.key_indicators.map((indicator, i) => (
                                                            <li key={i} className="text-slate-600 text-sm">{indicator}</li>
                                                        ))}
                                                    </ul>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <RiskMatrix />

                                {analysis.strategic_questions && (
                                    <div className="bg-white rounded-lg shadow-lg p-6">
                                        <h2 className="text-2xl font-bold text-slate-800 mb-4">Strategic Questions for Leadership</h2>
                                        <p className="text-slate-600 mb-4">Critical questions executives should be asking their organization</p>
                                        <ol className="space-y-3">
                                            {analysis.strategic_questions.map((q, idx) => (
                                                <li key={idx} className="flex gap-3">
                                                    <span className="flex-shrink-0 w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-bold">
                                                        {idx + 1}
                                                    </span>
                                                    <span className="text-slate-700">{q}</span>
                                                </li>
                                            ))}
                                        </ol>
                                    </div>
                                )}

                                {analysis.data_sources && (
                                    <div className="bg-white rounded-lg shadow-lg p-6">
                                        <h2 className="text-2xl font-bold text-slate-800 mb-4">Data Sources & References</h2>
                                        <p className="text-slate-600 mb-4">This analysis was informed by consideration of the following factors and sources</p>
                                        <ul className="space-y-2">
                                            {analysis.data_sources.map((source, idx) => (
                                                <li key={idx} className="flex gap-2 text-slate-700">
                                                    <span className="text-blue-600">üìö</span>
                                                    <span>{source}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<FuturesAnalysisDashboard />);
    </script>
</body>
</html>
